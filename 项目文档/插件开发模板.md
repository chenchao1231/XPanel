# XPanel插件开发模板

本文档提供了创建新插件的标准模板和代码示例，帮助开发者快速开始插件开发。

## 一、项目结构模板

### 1.1 创建项目目录

```
XPlugin[YourPluginName]/
├── Models/
├── Services/
├── UI/
├── Utils/
├── 插件文档/
├── [YourPluginName]Plugin.cs
├── XPlugin[YourPluginName].csproj
└── README.md
```

### 1.2 项目文件模板 (.csproj)

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0-windows</TargetFramework>
    <UseWindowsForms>true</UseWindowsForms>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <OutputPath>..\XPlugin\</OutputPath>
    <AssemblyName>XPlugin[YourPluginName]</AssemblyName>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\XPluginInterface\XPluginInterface.csproj" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="System.Text.Json" Version="8.0.0" />
  </ItemGroup>

</Project>
```

## 二、代码模板

### 2.1 插件主类模板

```csharp
using System;
using System.Drawing;
using System.Windows.Forms;
using XPlugin;
using XPlugin[YourPluginName].UI;

namespace XPlugin[YourPluginName]
{
    /// <summary>
    /// [YourPluginName]插件
    /// </summary>
    public class [YourPluginName]Plugin : IXPanelInterface
    {
        private static [YourPluginName]MainPanel? _currentPanel;

        public string Name => "[插件显示名称]";

        public UserControl CreatePanel()
        {
            try
            {
                // 如果已有面板实例，先清理
                if (_currentPanel != null)
                {
                    _currentPanel.Dispose();
                    _currentPanel = null;
                }

                _currentPanel = new [YourPluginName]MainPanel();
                return _currentPanel;
            }
            catch (Exception ex)
            {
                // 如果创建面板失败，返回错误信息面板
                return CreateErrorPanel(ex);
            }
        }

        /// <summary>
        /// 创建错误信息面板
        /// </summary>
        private static UserControl CreateErrorPanel(Exception ex)
        {
            var errorPanel = new UserControl
            {
                Size = new Size(800, 600),
                BackColor = Color.LightPink
            };

            var errorLabel = new Label
            {
                Text = $"[YourPluginName]插件加载失败：\n{ex.Message}\n\n堆栈跟踪：\n{ex.StackTrace}",
                Location = new Point(20, 20),
                Size = new Size(750, 500),
                Font = new Font("Microsoft YaHei", 10F),
                ForeColor = Color.Red,
                AutoSize = false
            };

            errorPanel.Controls.Add(errorLabel);
            return errorPanel;
        }

        /// <summary>
        /// 清理资源（当插件被卸载时调用）
        /// </summary>
        public static void Cleanup()
        {
            try
            {
                if (_currentPanel != null)
                {
                    System.Diagnostics.Debug.WriteLine("开始清理[YourPluginName]插件静态资源...");
                    _currentPanel.Dispose();
                    _currentPanel = null;
                    System.Diagnostics.Debug.WriteLine("[YourPluginName]插件静态资源清理完成");
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"清理[YourPluginName]插件资源失败: {ex.Message}");
            }
        }

        /// <summary>
        /// 当面板被外部释放时调用此方法清理静态引用
        /// </summary>
        internal static void OnPanelDisposed([YourPluginName]MainPanel panel)
        {
            try
            {
                if (_currentPanel == panel)
                {
                    System.Diagnostics.Debug.WriteLine("[YourPluginName]插件面板被外部释放，清理静态引用");
                    _currentPanel = null;
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"清理[YourPluginName]插件面板静态引用失败: {ex.Message}");
            }
        }
    }
}
```

### 2.2 数据模型模板 (Models/[YourPluginName]Config.cs)

```csharp
using System;
using System.Collections.Generic;

namespace XPlugin[YourPluginName].Models
{
    /// <summary>
    /// [YourPluginName]配置模型
    /// </summary>
    public class [YourPluginName]Config
    {
        /// <summary>
        /// 配置ID
        /// </summary>
        public string Id { get; set; } = Guid.NewGuid().ToString();

        /// <summary>
        /// 配置名称
        /// </summary>
        public string Name { get; set; } = string.Empty;

        /// <summary>
        /// 是否启用
        /// </summary>
        public bool IsEnabled { get; set; } = true;

        /// <summary>
        /// 创建时间
        /// </summary>
        public DateTime CreatedTime { get; set; } = DateTime.Now;

        /// <summary>
        /// 最后修改时间
        /// </summary>
        public DateTime LastModified { get; set; } = DateTime.Now;

        /// <summary>
        /// 描述信息
        /// </summary>
        public string Description { get; set; } = string.Empty;

        /// <summary>
        /// 扩展属性
        /// </summary>
        public Dictionary<string, object> ExtendedProperties { get; set; } = new Dictionary<string, object>();

        /// <summary>
        /// 验证配置是否有效
        /// </summary>
        /// <returns>true表示配置有效</returns>
        public bool IsValid()
        {
            return !string.IsNullOrWhiteSpace(Name);
        }

        /// <summary>
        /// 克隆配置对象
        /// </summary>
        /// <returns>克隆的配置对象</returns>
        public [YourPluginName]Config Clone()
        {
            return new [YourPluginName]Config
            {
                Id = this.Id,
                Name = this.Name,
                IsEnabled = this.IsEnabled,
                CreatedTime = this.CreatedTime,
                LastModified = DateTime.Now,
                Description = this.Description,
                ExtendedProperties = new Dictionary<string, object>(this.ExtendedProperties)
            };
        }
    }
}
```

### 2.3 配置管理服务模板 (Services/ConfigManager.cs)

```csharp
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text.Json;
using XPlugin[YourPluginName].Models;
using XPlugin.logs;

namespace XPlugin[YourPluginName].Services
{
    /// <summary>
    /// 配置管理服务
    /// </summary>
    public class ConfigManager
    {
        private readonly string _configFilePath;
        private readonly object _lockObject = new object();
        private List<[YourPluginName]Config> _configs;

        public ConfigManager()
        {
            _configFilePath = Path.Combine("Config", "[your_plugin_name]_config.json");
            _configs = new List<[YourPluginName]Config>();
            
            // 确保配置目录存在
            Directory.CreateDirectory(Path.GetDirectoryName(_configFilePath)!);
            
            // 加载配置
            LoadConfigs();
        }

        /// <summary>
        /// 获取所有配置
        /// </summary>
        /// <returns>配置列表</returns>
        public List<[YourPluginName]Config> GetAllConfigs()
        {
            lock (_lockObject)
            {
                return _configs.Select(c => c.Clone()).ToList();
            }
        }

        /// <summary>
        /// 根据ID获取配置
        /// </summary>
        /// <param name="id">配置ID</param>
        /// <returns>配置对象，不存在返回null</returns>
        public [YourPluginName]Config? GetConfig(string id)
        {
            lock (_lockObject)
            {
                return _configs.FirstOrDefault(c => c.Id == id)?.Clone();
            }
        }

        /// <summary>
        /// 添加配置
        /// </summary>
        /// <param name="config">要添加的配置</param>
        /// <returns>true表示添加成功</returns>
        public bool AddConfig([YourPluginName]Config config)
        {
            if (config == null || !config.IsValid())
            {
                return false;
            }

            lock (_lockObject)
            {
                // 检查名称是否重复
                if (_configs.Any(c => c.Name == config.Name))
                {
                    return false;
                }

                config.Id = Guid.NewGuid().ToString();
                config.CreatedTime = DateTime.Now;
                config.LastModified = DateTime.Now;
                
                _configs.Add(config.Clone());
                SaveConfigs();
                
                Log.Info($"添加配置: {config.Name}");
                return true;
            }
        }

        /// <summary>
        /// 更新配置
        /// </summary>
        /// <param name="config">要更新的配置</param>
        /// <returns>true表示更新成功</returns>
        public bool UpdateConfig([YourPluginName]Config config)
        {
            if (config == null || !config.IsValid())
            {
                return false;
            }

            lock (_lockObject)
            {
                var existingConfig = _configs.FirstOrDefault(c => c.Id == config.Id);
                if (existingConfig == null)
                {
                    return false;
                }

                // 检查名称是否与其他配置重复
                if (_configs.Any(c => c.Id != config.Id && c.Name == config.Name))
                {
                    return false;
                }

                var index = _configs.IndexOf(existingConfig);
                config.LastModified = DateTime.Now;
                _configs[index] = config.Clone();
                
                SaveConfigs();
                Log.Info($"更新配置: {config.Name}");
                return true;
            }
        }

        /// <summary>
        /// 删除配置
        /// </summary>
        /// <param name="id">配置ID</param>
        /// <returns>true表示删除成功</returns>
        public bool DeleteConfig(string id)
        {
            lock (_lockObject)
            {
                var config = _configs.FirstOrDefault(c => c.Id == id);
                if (config == null)
                {
                    return false;
                }

                _configs.Remove(config);
                SaveConfigs();
                
                Log.Info($"删除配置: {config.Name}");
                return true;
            }
        }

        /// <summary>
        /// 加载配置
        /// </summary>
        private void LoadConfigs()
        {
            try
            {
                if (File.Exists(_configFilePath))
                {
                    var json = File.ReadAllText(_configFilePath);
                    var configs = JsonSerializer.Deserialize<List<[YourPluginName]Config>>(json);
                    
                    if (configs != null)
                    {
                        lock (_lockObject)
                        {
                            _configs = configs;
                        }
                        Log.Info($"加载配置成功，共 {configs.Count} 个");
                    }
                }
                else
                {
                    // 创建默认配置
                    CreateDefaultConfig();
                }
            }
            catch (Exception ex)
            {
                Log.Error($"加载配置失败: {ex.Message}");
                CreateDefaultConfig();
            }
        }

        /// <summary>
        /// 保存配置
        /// </summary>
        private void SaveConfigs()
        {
            try
            {
                var json = JsonSerializer.Serialize(_configs, new JsonSerializerOptions
                {
                    WriteIndented = true
                });

                File.WriteAllText(_configFilePath, json);
                Log.Info($"保存配置成功，共 {_configs.Count} 个");
            }
            catch (Exception ex)
            {
                Log.Error($"保存配置失败: {ex.Message}");
            }
        }

        /// <summary>
        /// 创建默认配置
        /// </summary>
        private void CreateDefaultConfig()
        {
            var defaultConfig = new [YourPluginName]Config
            {
                Name = "默认配置",
                Description = "系统自动创建的默认配置"
            };

            lock (_lockObject)
            {
                _configs.Clear();
                _configs.Add(defaultConfig);
            }

            SaveConfigs();
            Log.Info("创建默认配置完成");
        }
    }
}
```

### 2.4 主面板模板 (UI/[YourPluginName]MainPanel.cs)

```csharp
using System;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;
using XPlugin.Theme;
using XPlugin[YourPluginName].Services;
using XPlugin.logs;

namespace XPlugin[YourPluginName].UI
{
    /// <summary>
    /// [YourPluginName]主面板
    /// </summary>
    public class [YourPluginName]MainPanel : UserControl
    {
        private readonly ConfigManager _configManager;
        private TextBox _logTextBox = null!;
        private Timer _refreshTimer = null!;

        public [YourPluginName]MainPanel()
        {
            _configManager = new ConfigManager();
            InitializeComponent();

            // 注册日志输出
            Log.RegisterOutput(new UILogOutput(message => AppendLog(message)));
            AppendLog("[YourPluginName]插件面板已启动");

            // 应用当前主题
            ThemeManager.ApplyTheme(this);

            // 监听主题变化
            ThemeManager.ThemeChanged += OnThemeChanged;
        }

        private void InitializeComponent()
        {
            Size = new Size(1200, 800);
            BackColor = Color.White;
            Dock = DockStyle.Fill;

            // 标题
            var titleLabel = new Label
            {
                Text = "[YourPluginName]插件",
                Font = new Font("Microsoft YaHei", 16F, FontStyle.Bold),
                Location = new Point(10, 10),
                Size = new Size(400, 30),
                ForeColor = Color.DarkBlue,
                Anchor = AnchorStyles.Top | AnchorStyles.Left
            };

            // 主要内容区域
            var contentPanel = new Panel
            {
                Location = new Point(10, 50),
                Size = new Size(1180, 600),
                BorderStyle = BorderStyle.FixedSingle,
                Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right
            };

            // TODO: 在这里添加你的主要功能界面

            // 日志区域
            var logGroup = new GroupBox
            {
                Text = "操作日志",
                Location = new Point(10, 660),
                Size = new Size(1180, 130),
                Font = new Font("Microsoft YaHei", 10F),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right
            };

            var clearLogButton = new Button
            {
                Text = "清空日志",
                Location = new Point(10, 25),
                Size = new Size(80, 25),
                UseVisualStyleBackColor = true
            };
            clearLogButton.Click += ClearLogButton_Click;

            _logTextBox = new TextBox
            {
                Location = new Point(10, 60),
                Size = new Size(1160, 60),
                Multiline = true,
                ScrollBars = ScrollBars.Vertical,
                ReadOnly = true,
                BackColor = Color.Black,
                ForeColor = Color.LimeGreen,
                Font = new Font("Consolas", 9F),
                Anchor = AnchorStyles.Top | AnchorStyles.Bottom | AnchorStyles.Left | AnchorStyles.Right
            };

            logGroup.Controls.AddRange(new Control[] { clearLogButton, _logTextBox });

            // 添加所有控件到主面板
            Controls.AddRange(new Control[] { titleLabel, contentPanel, logGroup });

            // 启动定时器
            _refreshTimer = new Timer
            {
                Interval = 5000 // 5秒刷新一次
            };
            _refreshTimer.Tick += RefreshTimer_Tick;
            _refreshTimer.Start();
        }

        private void OnThemeChanged(ThemeConfig theme)
        {
            if (InvokeRequired)
            {
                Invoke(new Action<ThemeConfig>(OnThemeChanged), theme);
                return;
            }

            ThemeManager.ApplyTheme(this);
        }

        private void AppendLog(string message)
        {
            if (InvokeRequired)
            {
                Invoke(new Action<string>(AppendLog), message);
                return;
            }

            try
            {
                if (_logTextBox != null)
                {
                    _logTextBox.AppendText($"{DateTime.Now:HH:mm:ss} {message}\r\n");
                    _logTextBox.SelectionStart = _logTextBox.Text.Length;
                    _logTextBox.ScrollToCaret();

                    // 限制日志长度
                    if (_logTextBox.Lines.Length > 500)
                    {
                        var lines = _logTextBox.Lines.Skip(100).ToArray();
                        _logTextBox.Lines = lines;
                    }
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"日志输出失败: {ex.Message}");
            }
        }

        private void ClearLogButton_Click(object? sender, EventArgs e)
        {
            _logTextBox.Clear();
            AppendLog("INFO: 日志已清空");
        }

        private void RefreshTimer_Tick(object? sender, EventArgs e)
        {
            try
            {
                // TODO: 在这里添加定时刷新逻辑
            }
            catch (Exception ex)
            {
                AppendLog($"ERROR: 刷新失败: {ex.Message}");
            }
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                try
                {
                    System.Diagnostics.Debug.WriteLine("[YourPluginName]插件面板Dispose被调用");

                    // 停止定时器
                    _refreshTimer?.Stop();
                    _refreshTimer?.Dispose();

                    // 取消事件注册
                    ThemeManager.ThemeChanged -= OnThemeChanged;

                    // 通知插件主类清理静态引用
                    [YourPluginName]Plugin.OnPanelDisposed(this);

                    System.Diagnostics.Debug.WriteLine("[YourPluginName]插件面板Dispose完成");
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"[YourPluginName]插件面板Dispose处理失败: {ex.Message}");
                }
            }
            base.Dispose(disposing);
        }
    }

    /// <summary>
    /// UI日志输出实现
    /// </summary>
    public class UILogOutput : ILogOutput
    {
        private readonly Action<string> _appendAction;

        public UILogOutput(Action<string> appendAction)
        {
            _appendAction = appendAction;
        }

        public void AppendLog(string message)
        {
            _appendAction?.Invoke(message);
        }
    }
}
```

### 2.5 工具类模板 (Utils/[YourPluginName]Helper.cs)

```csharp
using System;
using System.Collections.Generic;
using System.IO;
using System.Text.Json;

namespace XPlugin[YourPluginName].Utils
{
    /// <summary>
    /// [YourPluginName]辅助工具类
    /// </summary>
    public static class [YourPluginName]Helper
    {
        /// <summary>
        /// 验证字符串是否有效
        /// </summary>
        /// <param name="value">要验证的字符串</param>
        /// <param name="minLength">最小长度</param>
        /// <param name="maxLength">最大长度</param>
        /// <returns>true表示有效</returns>
        public static bool IsValidString(string value, int minLength = 1, int maxLength = 100)
        {
            return !string.IsNullOrWhiteSpace(value) && 
                   value.Length >= minLength && 
                   value.Length <= maxLength;
        }

        /// <summary>
        /// 生成唯一ID
        /// </summary>
        /// <param name="prefix">前缀</param>
        /// <returns>唯一ID</returns>
        public static string GenerateId(string prefix = "")
        {
            var timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
            return string.IsNullOrEmpty(prefix) ? 
                timestamp.ToString() : 
                $"{prefix}_{timestamp}";
        }

        /// <summary>
        /// 格式化时间为可读字符串
        /// </summary>
        /// <param name="dateTime">时间</param>
        /// <returns>格式化后的字符串</returns>
        public static string FormatDateTime(DateTime dateTime)
        {
            var now = DateTime.Now;
            var diff = now - dateTime;

            if (diff.TotalMinutes < 1)
                return "刚刚";
            if (diff.TotalMinutes < 60)
                return $"{(int)diff.TotalMinutes}分钟前";
            if (diff.TotalHours < 24)
                return $"{(int)diff.TotalHours}小时前";
            if (diff.TotalDays < 7)
                return $"{(int)diff.TotalDays}天前";
            
            return dateTime.ToString("yyyy-MM-dd HH:mm");
        }

        /// <summary>
        /// 导出数据到JSON文件
        /// </summary>
        /// <typeparam name="T">数据类型</typeparam>
        /// <param name="data">要导出的数据</param>
        /// <param name="filePath">文件路径</param>
        /// <returns>true表示导出成功</returns>
        public static bool ExportToJson<T>(T data, string filePath)
        {
            try
            {
                var json = JsonSerializer.Serialize(data, new JsonSerializerOptions
                {
                    WriteIndented = true,
                    Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
                });

                Directory.CreateDirectory(Path.GetDirectoryName(filePath)!);
                File.WriteAllText(filePath, json);
                return true;
            }
            catch
            {
                return false;
            }
        }

        /// <summary>
        /// 从JSON文件导入数据
        /// </summary>
        /// <typeparam name="T">数据类型</typeparam>
        /// <param name="filePath">文件路径</param>
        /// <returns>导入的数据，失败返回default(T)</returns>
        public static T? ImportFromJson<T>(string filePath)
        {
            try
            {
                if (!File.Exists(filePath))
                    return default(T);

                var json = File.ReadAllText(filePath);
                return JsonSerializer.Deserialize<T>(json);
            }
            catch
            {
                return default(T);
            }
        }

        /// <summary>
        /// 清理字符串（移除特殊字符）
        /// </summary>
        /// <param name="input">输入字符串</param>
        /// <returns>清理后的字符串</returns>
        public static string CleanString(string input)
        {
            if (string.IsNullOrWhiteSpace(input))
                return string.Empty;

            // 移除特殊字符
            var invalidChars = new[] { '<', '>', ':', '"', '|', '?', '*', '\\', '/' };
            var cleanString = input;
            
            foreach (var invalidChar in invalidChars)
            {
                cleanString = cleanString.Replace(invalidChar.ToString(), "");
            }

            return cleanString.Trim();
        }
    }
}
```

## 三、使用说明

### 3.1 创建新插件步骤

1. **复制模板目录结构**
2. **替换所有 `[YourPluginName]` 为你的插件名称**
3. **替换所有 `[your_plugin_name]` 为小写下划线格式**
4. **替换所有 `[插件显示名称]` 为用户看到的名称**
5. **根据需要修改和扩展功能**

### 3.2 批量替换建议

使用IDE的批量替换功能：
- `[YourPluginName]` → `MyAwesome`
- `[your_plugin_name]` → `my_awesome`
- `[插件显示名称]` → `我的超棒插件`

### 3.3 开发检查清单

- [ ] 项目结构符合规范
- [ ] 所有模板占位符已替换
- [ ] 实现了必需的接口
- [ ] 支持主题系统
- [ ] 集成了日志系统
- [ ] 实现了资源清理
- [ ] 添加了错误处理
- [ ] 编写了基本文档

---

使用此模板可以快速创建符合XPanel插件开发规范的新插件，确保代码质量和一致性。
