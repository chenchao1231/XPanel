# XPluginTcpServer 插件开发说明

## 插件概述

XPluginTcpServer是一个基于XPanel插件系统开发的TCP服务器管理插件，提供了完整的TCP服务器创建、管理、监控功能。

## 目录结构

```
XPluginTcpServer/
├── Models/                          # 数据模型层
│   ├── TcpServerConfig.cs          # TCP服务器配置模型
│   └── ClientConnectionInfo.cs     # 客户端连接信息模型
├── Services/                        # 业务服务层
│   ├── ConfigManager.cs            # 配置管理服务
│   ├── RealTcpServerManager.cs     # 真实TCP服务器管理器
│   └── SimpleTcpServerManager.cs   # 简化TCP服务器管理器
├── UI/                             # 用户界面层
│   ├── TcpServerManagementPanel.cs # 主管理面板
│   └── TcpServerConfigDialog.cs    # 配置对话框
├── Utils/                          # 工具类库
│   └── NetworkHelper.cs            # 网络辅助工具
├── 插件文档/                        # 插件文档
│   ├── 插件开发说明.md              # 本文档
│   ├── API文档.md                  # API接口文档
│   └── 使用手册.md                 # 用户使用手册
├── TcpServerPlugin.cs              # 插件主类
├── XPluginTcpServer.csproj         # 项目文件
└── README.md                       # 项目说明
```

## 核心组件说明

### 1. 数据模型层 (Models)

#### TcpServerConfig
TCP服务器配置模型，包含服务器的所有配置信息：
- 基本信息：ID、名称、IP地址、端口
- 运行参数：最大连接数、缓冲区大小
- 功能开关：自动启动、日志记录
- 状态信息：运行状态、连接统计
- 时间信息：创建时间、修改时间

#### ClientConnectionInfo
客户端连接信息模型，记录客户端连接的详细信息：
- 连接标识：连接ID、客户端IP、端口
- 时间信息：连接时间、断开时间
- 状态信息：连接状态、数据传输统计

### 2. 业务服务层 (Services)

#### ConfigManager
配置管理服务，负责TCP服务器配置的持久化：
- 配置文件读写（JSON格式）
- 配置的增删改查操作
- 配置验证和默认值处理
- 线程安全的配置访问

#### RealTcpServerManager
真实TCP服务器管理器，提供完整的TCP服务器功能：
- TCP服务器生命周期管理
- 客户端连接监控
- 数据传输处理
- 事件通知机制

#### SimpleTcpServerManager
简化TCP服务器管理器，用于演示和测试：
- 模拟TCP服务器行为
- 客户端连接模拟
- 基础的状态管理

### 3. 用户界面层 (UI)

#### TcpServerManagementPanel
主管理面板，提供完整的TCP服务器管理界面：
- 服务器列表显示和操作
- 客户端连接监控
- 实时日志输出
- 主题适配支持

#### TcpServerConfigDialog
配置对话框，用于添加和编辑TCP服务器配置：
- 服务器参数配置
- 输入验证和错误处理
- 主题适配支持

### 4. 工具类库 (Utils)

#### NetworkHelper
网络辅助工具类，提供网络相关的实用功能：
- 端口占用检测
- IP地址验证
- 网络连接测试
- 数据格式化工具

## 技术特性

### 1. 插件化架构
- 实现IXPanelInterface接口
- 支持动态加载和卸载
- 完整的资源清理机制

### 2. 异步编程
- 全面采用async/await模式
- 非阻塞的UI操作
- 高效的网络通信

### 3. 事件驱动
- 服务器状态变化事件
- 客户端连接变化事件
- UI实时更新机制

### 4. 主题支持
- 自动适配系统主题
- 主题变化响应
- 一致的视觉体验

### 5. 配置管理
- JSON格式配置文件
- 配置热更新
- 配置验证和恢复

## 开发规范

### 1. 代码规范
- 遵循C#编码规范
- 使用XML文档注释
- 实现完整的异常处理
- 正确的资源管理

### 2. 命名规范
- 类名使用PascalCase
- 方法名使用PascalCase
- 字段名使用camelCase（私有字段以_开头）
- 常量使用UPPER_CASE

### 3. 文件组织
- 按功能模块组织目录
- 每个类单独一个文件
- 相关类放在同一命名空间

### 4. 异常处理
- 使用try-catch包装可能出错的代码
- 记录详细的错误日志
- 提供用户友好的错误提示

## 扩展开发

### 1. 添加新功能
1. 在Models目录下添加数据模型
2. 在Services目录下实现业务逻辑
3. 在UI目录下创建用户界面
4. 在Utils目录下添加工具类

### 2. 自定义协议支持
1. 继承或实现TCP服务器基类
2. 添加协议解析逻辑
3. 实现数据处理方法
4. 集成到管理界面

### 3. 性能监控
1. 添加性能指标收集
2. 实现监控数据存储
3. 创建监控界面
4. 添加告警机制

## 配置文件格式

### TCP服务器配置 (Config/tcp_server_config.json)
```json
{
  "Servers": [
    {
      "Id": "server-001",
      "Name": "主TCP服务器",
      "IpAddress": "127.0.0.1",
      "Port": 8080,
      "AutoStart": true,
      "EnableLogging": true,
      "MaxConnections": 1000,
      "BufferSize": 1024,
      "CreatedTime": "2024-01-01T00:00:00",
      "LastModified": "2024-01-01T00:00:00",
      "Description": "主要的TCP服务器",
      "IsRunning": false,
      "CurrentConnections": 0,
      "TotalConnections": 0
    }
  ]
}
```

## 事件系统

### 服务器状态事件
```csharp
public class ServerStatusEventArgs : EventArgs
{
    public string ServerId { get; set; }
    public bool IsRunning { get; set; }
    public string Message { get; set; }
}
```

### 客户端连接事件
```csharp
public class ClientConnectionEventArgs : EventArgs
{
    public string ServerId { get; set; }
    public string ConnectionId { get; set; }
    public bool IsConnected { get; set; }
    public string ClientEndPoint { get; set; }
}
```

## 最佳实践

### 1. 资源管理
- 实现IDisposable接口
- 在Dispose方法中清理资源
- 使用using语句管理临时资源

### 2. 线程安全
- 使用ConcurrentDictionary存储共享数据
- UI更新使用Invoke机制
- 避免在UI线程执行耗时操作

### 3. 错误处理
- 捕获并记录所有异常
- 提供有意义的错误消息
- 实现优雅的错误恢复

### 4. 性能优化
- 使用异步操作避免阻塞
- 合理设置缓冲区大小
- 定期清理不用的连接

## 测试建议

### 1. 单元测试
- 测试配置管理功能
- 测试网络工具类
- 测试数据模型验证

### 2. 集成测试
- 测试TCP服务器启停
- 测试客户端连接处理
- 测试配置持久化

### 3. 性能测试
- 测试并发连接处理
- 测试内存使用情况
- 测试长时间运行稳定性

---

**文档版本**: 1.0.0  
**最后更新**: 2025年7月31日  
**维护者**: 开发团队
